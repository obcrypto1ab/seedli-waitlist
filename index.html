<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presale Registration</title>
    
    <!-- 1. Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Default accent, will be overridden by JS
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- 2. ImageKit SDK -->
    <script type="text/javascript" src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>

    <!-- 3. Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Loader */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid currentColor; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-dark { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-white transition-colors duration-300 min-h-screen flex flex-col font-sans">

    <!-- ================= CONFIGURATION ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, setDoc, query, where, orderBy, limit, startAfter, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- CONFIG: UPDATED WITH YOUR VALUES ---
        const CONFIG = {
            adminEmail: "info@seedlicapital.com", // Must match Security Rules
            imagekitUrlEndpoint: "https://ik.imagekit.io/yzlzej9ph", // From ImageKit Dashboard
            imagekitPublicKey: "public_GNt4gOGsp4kQ5AASRJs4gljRb+4=", // From ImageKit Dashboard
            firebaseConfig: {
                apiKey: "AIzaSyDg0Q7UE-iu_fCtxQ9m2IrRHEsg4tpMYqI",
                authDomain: "seedli-bd7c4.firebaseapp.com",
                projectId: "seedli-bd7c4",
                storageBucket: "seedli-bd7c4.firebasestorage.app",
                messagingSenderId: "95614477384",
                appId: "1:95614477384:web:8b1afa1f19e0619efd247d"
            }
        };

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            settings: {
                siteName: "Presale Launch",
                tagline: "Join the future of finance.",
                primaryCtaText: "Join Waitlist",
                logoUrl: "",
                heroBackgroundUrl: "", // Optional
                accentColor: "#3b82f6" // Default Blue
            },
            submissions: [],
            lastDoc: null, // For pagination
            loading: false,
            filterAmount: 'all',
            searchQuery: ''
        };

        // --- FIREBASE INIT ---
        const app = initializeApp(CONFIG.firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- IMAGEKIT INIT ---
        const imagekit = new ImageKit({
            publicKey: CONFIG.imagekitPublicKey,
            urlEndpoint: CONFIG.imagekitUrlEndpoint,
            authenticationEndpoint: "/api/imagekit-auth" // Calls Vercel API
        });

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            toastContainer: document.getElementById('toast-container'),
            darkModeToggle: document.getElementById('dark-mode-toggle')
        };

        // --- INITIALIZATION ---
        async function init() {
            // Theme Check
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            // Load Settings
            await loadSettings();
            
            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                render();
            });
        }

        // --- DATA SERVICE ---
        async function loadSettings() {
            try {
                const docRef = doc(db, "settings", "site");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    state.settings = { ...state.settings, ...docSnap.data() };
                    applyBranding();
                }
            } catch (e) {
                console.warn("Settings not found or permission denied (first run). using defaults.");
            }
        }

        function applyBranding() {
            document.title = state.settings.siteName;
            // Inject custom accent color dynamically
            const style = document.createElement('style');
            style.innerHTML = `
                .bg-accent { background-color: ${state.settings.accentColor} !important; }
                .text-accent { color: ${state.settings.accentColor} !important; }
                .border-accent { border-color: ${state.settings.accentColor} !important; }
                .hover-bg-accent:hover { background-color: ${state.settings.accentColor} !important; filter: brightness(90%); }
            `;
            document.head.appendChild(style);
        }

        async function submitForm(e) {
            e.preventDefault();
            const email = document.getElementById('public-email').value;
            const amount = document.getElementById('public-amount').value;

            if(!email || !amount) return showToast("Please fill all fields", "error");

            setLoading(true, "submit-btn");

            try {
                // Get IP (simple fetch, optional)
                let ipData = {}; 
                try { const res = await fetch('https://api.ipify.org?format=json'); ipData = await res.json(); } catch(e){}

                await addDoc(collection(db, "submissions"), {
                    email: email,
                    amountRange: amount,
                    createdAt: serverTimestamp(),
                    ip: ipData.ip || 'unknown',
                    userAgent: navigator.userAgent
                });

                document.getElementById('public-form').reset();
                showToast("Successfully registered!", "success");
            } catch (error) {
                console.error(error);
                showToast("Submission failed. Try again.", "error");
            } finally {
                setLoading(false, "submit-btn");
            }
        }

        // --- ADMIN ACTIONS ---
        async function loginAdmin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-pass').value;

            setLoading(true, "login-btn");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast("Welcome back, Admin", "success");
            } catch (error) {
                showToast("Login failed: " + error.message, "error");
            } finally {
                setLoading(false, "login-btn");
            }
        }

        async function logout() {
            await signOut(auth);
            window.location.reload();
        }

        async function fetchSubmissions(reset = true) {
            if (reset) {
                state.submissions = [];
                state.lastDoc = null;
            }

            setLoading(true, "load-more-btn");

            try {
                let q = query(
                    collection(db, "submissions"),
                    orderBy("createdAt", "desc"),
                    limit(10)
                );

                if (state.filterAmount !== 'all') {
                    q = query(q, where("amountRange", "==", state.filterAmount));
                }

                if (state.lastDoc) {
                    q = query(q, startAfter(state.lastDoc));
                }

                const snapshot = await getDocs(q);
                state.lastDoc = snapshot.docs[snapshot.docs.length - 1];
                
                let newSubs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

                // Client side search (Firestore doesn't support partial text search natively easily)
                if(state.searchQuery) {
                    newSubs = newSubs.filter(s => s.email.toLowerCase().includes(state.searchQuery.toLowerCase()));
                }

                state.submissions = [...state.submissions, ...newSubs];
                renderAdminDashboard();
            } catch (error) {
                showToast("Error loading data: " + error.message, "error");
            } finally {
                setLoading(false, "load-more-btn");
            }
        }

        async function deleteSubmission(id) {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "submissions", id));
                state.submissions = state.submissions.filter(s => s.id !== id);
                renderAdminDashboard();
                showToast("Deleted", "success");
            } catch (e) {
                showToast(e.message, "error");
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            setLoading(true, "save-settings-btn");
            
            const formData = new FormData(e.target);
            const updates = {
                siteName: formData.get('siteName'),
                tagline: formData.get('tagline'),
                primaryCtaText: formData.get('primaryCtaText'),
                accentColor: formData.get('accentColor'),
                logoUrl: state.settings.logoUrl, // Preserved unless uploaded
                heroBackgroundUrl: state.settings.heroBackgroundUrl
            };

            try {
                // Upload Logo if present
                const logoFile = document.getElementById('logo-upload').files[0];
                if(logoFile) {
                   const res = await uploadToImageKit(logoFile);
                   updates.logoUrl = res.url;
                }

                // Upload Hero if present
                const heroFile = document.getElementById('hero-upload').files[0];
                if(heroFile) {
                   const res = await uploadToImageKit(heroFile);
                   updates.heroBackgroundUrl = res.url;
                }

                await setDoc(doc(db, "settings", "site"), updates, { merge: true });
                state.settings = { ...state.settings, ...updates };
                applyBranding();
                showToast("Settings saved!", "success");
            } catch (error) {
                showToast("Save failed: " + error.message, "error");
            } finally {
                setLoading(false, "save-settings-btn");
            }
        }

      async function uploadToImageKit(file) {
  // Convert File -> base64
  const base64 = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

  return new Promise((resolve, reject) => {
    imagekit.upload(
      {
        file: base64, // base64 string
        fileName: "site_asset_" + Date.now(),
        tags: ["site-assets"]
      },
      (err, result) => {
        if (err) reject(err);
        else resolve(result);
      }
    );
  });
}

        function exportCSV() {
            const headers = ["ID", "Email", "Amount Range", "Created At", "IP"];
            const rows = state.submissions.map(s => [
                s.id, 
                s.email, 
                s.amountRange, 
                s.createdAt ? new Date(s.createdAt.seconds * 1000).toLocaleString() : '',
                s.ip
            ]);
            
            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");
                
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "submissions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UI HELPERS ---
        function setLoading(isLoading, btnId) {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            if(isLoading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = `<div class="loader mx-auto"></div>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || 'Submit';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `fixed bottom-5 right-5 ${color} text-white px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center gap-2 z-50`;
            toast.innerHTML = `<span>${message}</span>`;
            els.toastContainer.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
        }

        // --- RENDERERS ---
        function render() {
            const isAdmin = state.user && state.user.email === CONFIG.adminEmail;

            // Header
            const headerHtml = `
                <nav class="w-full glass-dark sticky top-0 z-40 border-b border-slate-200 dark:border-slate-800">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center gap-2">
                                ${state.settings.logoUrl ? `<img src="${state.settings.logoUrl}" class="h-8 w-auto" alt="Logo">` : ''}
                                <span class="font-bold text-xl tracking-tight text-accent">${state.settings.siteName}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="window.toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition">
                                    <i data-lucide="moon" class="w-5 h-5"></i>
                                </button>
                                ${isAdmin ? `
                                    <button onclick="window.location.reload()" class="text-sm font-medium hover:text-accent">Dashboard</button>
                                    <button onclick="window.logout()" class="text-sm font-medium text-red-500 hover:text-red-400">Logout</button>
                                ` : `
                                    <button onclick="window.showLoginModal()" class="text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">Admin</button>
                                `}
                            </div>
                        </div>
                    </div>
                </nav>
            `;

            let mainHtml = '';

            if (isAdmin) {
                // Admin View
                mainHtml = `
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
                        <!-- Tabs -->
                        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                            <button id="tab-subs" class="px-4 py-2 border-b-2 border-accent font-medium text-accent">Submissions</button>
                            <button id="tab-settings" class="px-4 py-2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300" onclick="window.switchTab('settings')">Settings</button>
                        </div>

                        <!-- Submissions Panel -->
                        <div id="panel-subs">
                            <div class="flex flex-col md:flex-row gap-4 mb-6 justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                                <div class="text-lg font-bold">Total: <span id="total-count">...</span></div>
                                <div class="flex gap-2 w-full md:w-auto">
                                    <input type="text" placeholder="Search email..." class="px-3 py-2 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-accent outline-none" oninput="state.searchQuery = this.value; window.fetchSubmissions()">
                                    <select onchange="state.filterAmount = this.value; window.fetchSubmissions()" class="px-3 py-2 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-accent outline-none">
                                        <option value="all">All Amounts</option>
                                        <option value="$100 - $1,000">$100 - $1,000</option>
                                        <option value="$1,000 - $5,000">$1,000 - $5,000</option>
                                        <option value="$5,000+">$5,000+</option>
                                    </select>
                                    <button onclick="window.exportCSV()" class="p-2 bg-slate-200 dark:bg-slate-700 rounded hover:opacity-80"><i data-lucide="download" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-slate-800 rounded-lg shadow overflow-hidden border border-slate-200 dark:border-slate-700">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 uppercase font-medium">
                                            <tr>
                                                <th class="px-6 py-3">Date</th>
                                                <th class="px-6 py-3">Email</th>
                                                <th class="px-6 py-3">Amount</th>
                                                <th class="px-6 py-3">IP</th>
                                                <th class="px-6 py-3 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subs-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                                            <!-- Rows injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="load-more-btn" onclick="window.fetchSubmissions(false)" class="text-sm text-accent hover:underline">Load More</button>
                            </div>
                        </div>

                        <!-- Settings Panel (Hidden by default) -->
                        <div id="panel-settings" class="hidden max-w-2xl mx-auto">
                            <form id="settings-form" onsubmit="window.saveSettings(event)" class="space-y-6 bg-white dark:bg-slate-800 p-6 rounded-lg border border-slate-200 dark:border-slate-700">
                                <h2 class="text-xl font-bold mb-4">Branding Settings</h2>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Site Name</label>
                                    <input type="text" name="siteName" value="${state.settings.siteName}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:border-accent outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Tagline</label>
                                    <input type="text" name="tagline" value="${state.settings.tagline}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:border-accent outline-none">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Primary CTA Text</label>
                                        <input type="text" name="primaryCtaText" value="${state.settings.primaryCtaText}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:border-accent outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Accent Color</label>
                                        <input type="color" name="accentColor" value="${state.settings.accentColor}" class="w-full h-10 p-1 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Logo (Upload to replace)</label>
                                    <div class="flex items-center gap-4">
                                        ${state.settings.logoUrl ? `<img src="${state.settings.logoUrl}" class="h-10 w-10 object-contain bg-slate-200 rounded">` : ''}
                                        <input type="file" id="logo-upload" accept="image/*" class="text-sm">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">Hero Background (Upload to replace)</label>
                                    <div class="flex items-center gap-4">
                                        ${state.settings.heroBackgroundUrl ? `<img src="${state.settings.heroBackgroundUrl}" class="h-10 w-20 object-cover bg-slate-200 rounded">` : ''}
                                        <input type="file" id="hero-upload" accept="image/*" class="text-sm">
                                    </div>
                                </div>

                                <button id="save-settings-btn" type="submit" class="w-full bg-accent hover-bg-accent text-white py-2 rounded font-bold transition">Save Changes</button>
                            </form>
                        </div>
                    </div>
                `;
            } else {
                // Public View
                const bgStyle = state.settings.heroBackgroundUrl 
                    ? `background-image: linear-gradient(to bottom, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.9)), url('${state.settings.heroBackgroundUrl}'); background-size: cover; background-position: center;`
                    : '';
                
                mainHtml = `
                    <div class="flex-grow flex items-center justify-center p-4 relative overflow-hidden" style="${bgStyle}">
                        <!-- Background Blobs -->
                        <div class="absolute top-0 left-0 w-72 h-72 bg-accent opacity-20 blur-3xl rounded-full mix-blend-multiply filter animate-blob"></div>
                        <div class="absolute top-0 right-0 w-72 h-72 bg-purple-500 opacity-20 blur-3xl rounded-full mix-blend-multiply filter animate-blob animation-delay-2000"></div>

                        <div class="relative w-full max-w-md bg-white/10 dark:bg-slate-900/50 backdrop-blur-xl border border-white/20 dark:border-slate-700 rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                            <div class="p-8">
                                <div class="text-center mb-8">
                                    <h1 class="text-3xl font-extrabold mb-2 text-slate-900 dark:text-white">${state.settings.siteName}</h1>
                                    <p class="text-slate-600 dark:text-slate-300">${state.settings.tagline}</p>
                                </div>

                                <form id="public-form" onsubmit="window.submitForm(event)" class="space-y-5">
                                    <div>
                                        <label for="public-email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Address</label>
                                        <input type="email" id="public-email" required class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-all" placeholder="you@example.com">
                                    </div>

                                    <div>
                                        <label for="public-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Intended Contribution</label>
                                        <select id="public-amount" required class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-accent outline-none appearance-none">
                                            <option value="" disabled selected>Select an amount range</option>
                                            <option value="$100 - $1,000">$100 - $1,000</option>
                                            <option value="$1,000 - $5,000">$1,000 - $5,000</option>
                                            <option value="$5,000+">$5,000+</option>
                                        </select>
                                    </div>

                                    <button id="submit-btn" type="submit" class="w-full bg-accent hover-bg-accent text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition hover:scale-[1.02] focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                                        ${state.settings.primaryCtaText}
                                    </button>
                                </form>
                                <p class="text-center text-xs text-slate-500 mt-6">Secure registration. No spam.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            els.app.innerHTML = headerHtml + mainHtml;
            lucide.createIcons();
            
            if (isAdmin) {
                fetchSubmissions();
            }
        }

        // --- ADMIN HELPERS ---
        window.switchTab = (tab) => {
            document.getElementById('panel-subs').classList.add('hidden');
            document.getElementById('panel-settings').classList.add('hidden');
            document.getElementById('panel-' + tab).classList.remove('hidden');
            
            document.getElementById('tab-subs').className = tab === 'subs' ? 'px-4 py-2 border-b-2 border-accent font-medium text-accent' : 'px-4 py-2 text-slate-500';
            document.getElementById('tab-settings').className = tab === 'settings' ? 'px-4 py-2 border-b-2 border-accent font-medium text-accent' : 'px-4 py-2 text-slate-500';
        };

        function renderAdminDashboard() {
            const tbody = document.getElementById('subs-table-body');
            document.getElementById('total-count').innerText = state.submissions.length + "+";
            
            if (state.submissions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No submissions found.</td></tr>`;
                return;
            }

            tbody.innerHTML = state.submissions.map(sub => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-slate-500 dark:text-slate-400">${sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleDateString() : 'Pending'}</td>
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${sub.email}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            ${sub.amountRange}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400 text-xs font-mono">${sub.ip}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteSubmission('${sub.id}')" class="text-red-600 hover:text-red-900 dark:hover:text-red-400">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // --- GLOBAL EXPORTS ---
        window.toggleDarkMode = toggleDarkMode;
        window.submitForm = submitForm;
        window.loginAdmin = loginAdmin;
        window.logout = logout;
        window.showLoginModal = () => {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm";
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-sm relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
                    <h2 class="text-2xl font-bold mb-6 text-center">Admin Access</h2>
                    <form onsubmit="window.loginAdmin(event); this.closest('.fixed').remove()">
                        <div class="space-y-4">
                            <input type="email" id="admin-email" placeholder="Admin Email" class="w-full p-3 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 outline-none focus:border-accent">
                            <input type="password" id="admin-pass" placeholder="Password" class="w-full p-3 rounded bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 outline-none focus:border-accent">
                            <button id="login-btn" type="submit" class="w-full bg-accent text-white py-3 rounded font-bold hover:brightness-90">Login</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        };
        window.fetchSubmissions = fetchSubmissions;
        window.saveSettings = saveSettings;
        window.deleteSubmission = deleteSubmission;
        window.uploadToImageKit = uploadToImageKit;
        window.exportCSV = exportCSV;

        // Run
        init();
    </script>

    <!-- App Container -->
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Loader during init -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="loader text-accent"></div>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toast-container"></div>

</body>
</html>
